name: Deploy with AWS Copilot

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.out.outputs.app }}
      envs: ${{ steps.out.outputs.envs }}
      svcs: ${{ steps.out.outputs.svcs }}
      matrix: ${{ steps.out.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install dependencies (jq + Copilot)
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          if ! command -v copilot >/dev/null 2>&1; then
            curl -Lo copilot-linux https://ecs-cli-v2-release.s3.amazonaws.com/copilot-linux-v1.32.0
            sudo mv copilot-linux /usr/local/bin/copilot
            sudo chmod +x /usr/local/bin/copilot
          fi
          copilot --version
          jq --version

      - name: Read app name from copilot/.workspace
        id: app
        shell: bash
        run: |
          if [[ ! -f copilot/.workspace ]]; then
            echo "copilot/.workspace not found." >&2
            exit 1
          fi
          APP="$(awk -F': *' '/^application:/ {gsub(/^[ \t]+|[ \t\r\n]+$/, "", $2); print $2; exit}' copilot/.workspace)"
          if [[ -z "$APP" ]]; then
            echo "Could not parse 'application:' from copilot/.workspace" >&2
            exit 1
          fi
          echo "Detected app: $APP"
          echo "APP=$APP" >> "$GITHUB_ENV"

      - name: Discover envs & svcs and build matrices
        id: discover
        shell: bash
        run: |
          set -euo pipefail

          # Discover environments from filesystem (copilot/environments/*)
          ENV_JSON="[]"
          if [ -d "copilot/environments" ]; then
            ENV_JSON=$(find copilot/environments -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          
          # Discover services from filesystem (copilot/*)
          SVC_JSON="[]"
          if [ -d "copilot" ]; then
            SVC_JSON=$(find copilot -mindepth 1 -maxdepth 1 -type d ! -name "environments" ! -name "pipelines" -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi

          echo "ENV_JSON: $ENV_JSON"
          echo "SVC_JSON: $SVC_JSON"

          # Build cross product matrix of {env, svc}
          export ENV_JSON SVC_JSON
          MATRIX_JSON="$(python3 - <<'PY'
          import json, os
          envs = json.loads(os.environ.get("ENV_JSON","[]"))
          svcs = json.loads(os.environ.get("SVC_JSON","[]"))
          matrix = [ {"env": e, "svc": s} for e in envs for s in svcs ]
          print(json.dumps(matrix))
          PY
          )"
          echo "MATRIX_JSON: $MATRIX_JSON"

          # Stash to files for debugging (optional)
          printf '%s\n' "$ENV_JSON" > envs.names.json
          printf '%s\n' "$SVC_JSON" > svcs.names.json
          printf '%s\n' "$MATRIX_JSON" > matrix.json

          # Expose outputs (use heredoc for JSON)
          {
            echo "app=$APP"
            echo 'envs<<EOF'
            echo "$ENV_JSON"
            echo 'EOF'
            echo 'svcs<<EOF'
            echo "$SVC_JSON"
            echo 'EOF'
            echo 'matrix<<EOF'
            echo "$MATRIX_JSON"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Show discovery results (debug)
        shell: bash
        run: |
          echo "App: $APP"
          echo "Envs: $(cat envs.names.json)"
          echo "Svcs: $(cat svcs.names.json)"
          echo "Matrix: $(cat matrix.json)"

      - name: Set composite outputs
        id: out
        run: |
          # pass-through step so outputs.* are available to downstream jobs via this step id
          {
            echo "app=${APP}"
            echo 'envs<<EOF';  cat envs.names.json; echo 'EOF'
            echo 'svcs<<EOF';  cat svcs.names.json; echo 'EOF'
            echo 'matrix<<EOF'; cat matrix.json; echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  # Phase 1: deploy all environments (can run in parallel). Must complete before services.
  env-deploy:
    needs: prepare
    if: ${{ needs.prepare.outputs.envs != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: ${{ fromJson(needs.prepare.outputs.envs) }}
    env:
      APP: ${{ needs.prepare.outputs.app }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install Copilot CLI
        shell: bash
        run: |
          if ! command -v copilot >/dev/null 2>&1; then
            curl -Lo /tmp/copilot https://github.com/aws/copilot-cli/releases/latest/download/copilot-linux
            chmod +x /tmp/copilot
            sudo mv /tmp/copilot /usr/local/bin/copilot
          fi
          copilot --version

      - name: Initialize Copilot app if not exists
        shell: bash
        run: |
          set -euo pipefail
          # Check if app exists in AWS
          if ! copilot app show --name "$APP" >/dev/null 2>&1; then
            echo "App $APP not found in AWS, initializing..."
            copilot app init "$APP"
          else
            echo "App $APP already exists"
          fi

      - name: Initialize environment ${{ matrix.env }} if not exists
        shell: bash
        run: |
          set -euo pipefail
          # Check if environment exists
          if ! copilot env show --app "$APP" --name "${{ matrix.env }}" >/dev/null 2>&1; then
            echo "Environment ${{ matrix.env }} not found, initializing..."
            # Initialize environment with default VPC (use --default-config for non-interactive)
            copilot env init \
              --app "$APP" \
              --name "${{ matrix.env }}" \
              --default-config
          else
            echo "Environment ${{ matrix.env }} already exists"
          fi

      - name: Deploy environment ${{ matrix.env }}
        shell: bash
        run: |
          set -euo pipefail
          echo "copilot env deploy --app '$APP' --name '${{ matrix.env }}'"
          copilot env deploy --app "$APP" --name "${{ matrix.env }}"

  # Phase 2: deploy each service to each environment (cross-product matrix)
  svc-deploy:
    needs: [prepare, env-deploy]
    if: ${{ needs.prepare.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        combo: ${{ fromJson(needs.prepare.outputs.matrix) }}
    env:
      APP: ${{ needs.prepare.outputs.app }}
      ENV: ${{ matrix.combo.env }}
      SVC: ${{ matrix.combo.svc }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install Copilot CLI
        shell: bash
        run: |
          if ! command -v copilot >/dev/null 2>&1; then
            curl -Lo /tmp/copilot https://github.com/aws/copilot-cli/releases/latest/download/copilot-linux
            chmod +x /tmp/copilot
            sudo mv /tmp/copilot /usr/local/bin/copilot
          fi
          copilot --version

      - name: Deploy service ${{ env.SVC }} to env ${{ env.ENV }}
        shell: bash
        run: |
          set -euo pipefail
          echo "copilot svc deploy --app '$APP' --env '${ENV}' --name '${SVC}'"
          copilot svc deploy --app "$APP" --env "$ENV" --name "$SVC"